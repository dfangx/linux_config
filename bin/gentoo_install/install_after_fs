#!/bin/bash

gentoo_mnt="/mnt/gentoo"
root="/dev/sda8"
home="/dev/sda7"
chroot_script="./gentoo_chroot"
checkpoint=$1

function mount_root {
    mkdir -v --parents "$gentoo_mnt"
    mount -v "$root" "$gentoo_mnt"
    cd  "$gentoo_mnt"
}

function prepare_portage {
    portage_home_dir=/home/gentoo/cyrusng/.config/portage
    portage_sys_dir="$gentoo_mnt"/etc/portage

    rm -vr "$portage_sys_dir"/make.conf
    ln -sv "$portage_home_dir"/make.conf "$portage_sys_dir"/make.conf 
    vim "$portage_sys_dir"/make.conf

    rm -vr "$portage_sys_dir"/package.use
    ln -sv "$portage_home_dir"/package.use "$portage_sys_dir"/package.use 
    vim "$portage_sys_dir"/package.use

    rm "$portage_sys_dir"/package.accept_keywords
    ln -sv "$portage_home_dir"/package.accept_keywords "$portage_sys_dir"/package.accept_keywords 
    vim "$portage_sys_dir"/package.accept_keywords

    mkdir -v --parents "$portage_sys_dir"/repos.conf
    cp -v "$gentoo_mnt"/usr/share/portage/config/repos.conf "$portage_sys_dir"/repos.conf/gentoo.conf
}

function unpack_stage3 {
    url="https://mirror.csclub.uwaterloo.ca/gentoo-distfiles/releases/amd64/autobuilds/current-install-amd64-minimal/"
    url_mn="https://mirror.csclub.uwaterloo.ca/gentoo-distfiles/"
    url_bk1="http://mirror.csclub.uwaterloo.ca/gentoo-distfiles/"
    url_bk2="ftp://mirror.csclub.uwaterloo.ca/gentoo-distfiles/"
    stage3="stage3-amd64-20190221T214502Z.tar.xz"    

    wget -v "$url$stage3"
    if [ $? -ne 0 ]; then
	    exit 1
    fi
    tar xpvf "$stage3" --xattrs-include='*.*' --numeric-owner
}

function mount_fs {
    mount -v --types proc /proc "$gentoo_mnt"/proc 
    mount -v --rbind /sys "$gentoo_mnt"/sys
    mount -v --make-rslave "$gentoo_mnt"/sys
    mount -v --rbind /dev "$gentoo_mnt"/dev 
    mount -v --make-rslave "$gentoo_mnt"/dev 
    mount -v "$home" "$gentoo_mnt"/home
}

function enter_chroot {
    shell="/bin/bash"

    cp -v /home/arch/cyrusng/documents/projects/gentoo_install/install/gentoo_chroot "$gentoo_mnt"
    cp -v --dereference /etc/resolv.conf "$gentoo_mnt"/etc/
    env -i HOME=$HOME TERM=$TERM chroot /mnt/gentoo /bin/bash -c "$chroot_script"
}

function end_chroot {
    rm -v "$gentoo_mnt"/"$stage3" "$chroot_script"
    umount -vR "$gentoo_mnt"
}

if [ -z "$checkpoint" ]; then
    echo Enter 0 or 1 checkpoint flag
    exit 1
elif [ "$checkpoint" -ne 0 ] && [ "$checkpoint" -ne 1 ]; then
    echo Enter 0 or 1 checkpoint flag
    exit 1
fi

mount_root

if [ "$checkpoint" -eq 0 ]; then
    unpack_stage3
fi

mount_fs
if [ "$checkpoint" -eq 0 ]; then
    prepare_portage
fi

enter_chroot
end_chroot
